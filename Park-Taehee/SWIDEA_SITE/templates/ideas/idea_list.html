<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì•„ì´ë””ì–´ ê´€ë¦¬</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'ideas/styles.css' %}" />
  </head>
  <body>
    <div id="top" style="border-bottom: 1px solid rgb(242, 240, 240)">
      <a id="home" href="{% url 'idea_list' %}">
        My <span style="color: rgb(75, 255, 84)">SW Idea</span> Manage
      </a>
      <a href="{% url 'idea_create' %}">ì•„ì´ë””ì–´ ë“±ë¡</a>
      <a href="{% url 'idea_list' %}">ì•„ì´ë””ì–´ ê´€ë¦¬</a>
      <a href="{% url 'devtool_create' %}">ê°œë°œíˆ´ ë“±ë¡</a>
      <a href="{% url 'devtool_list' %}">ê°œë°œíˆ´ ê´€ë¦¬</a>
    </div>

    <!-- ì •ë ¬ ê¸°ì¤€ ì„ íƒ -->
    <form method="get" action="{% url 'idea_list' %}" style="margin-bottom: 20px;">
      <select id="sort_by" name="sort_by" onchange="this.form.submit()">
        <option value="" {% if not sort_by %}selected="selected"{% endif %}>-- ì •ë ¬ ê¸°ì¤€ --</option>
        <option value="interest" {% if sort_by == 'interest' %}selected="selected"{% endif %}>ì°œí•˜ê¸°ìˆœ</option>
        <option value="name" {% if sort_by == 'name' %}selected="selected"{% endif %}>ì´ë¦„ìˆœ</option>
        <option value="created_at" {% if sort_by == 'created_at' %}selected="selected"{% endif %}>ë“±ë¡ìˆœ</option>
        <option value="latest" {% if sort_by == 'latest' %}selected="selected"{% endif %}>ìµœì‹ ìˆœ</option>
      </select>
    </form>


    <div id="bottom">
      {% for idea in ideas %}
      <div class="item">
        <div class="image-container">
          <img src="{{ idea.image.url }}" alt="{{ idea.title }}" />
          <button class="star-button" data-idea-id="{{ idea.id }}" 
              style="color: {% if idea.stars > 0 %}gold{% else %}gray{% endif %};">
            {% if idea.stars > 0 %}â˜…{% else %}â˜†{% endif %}
          </button>
        </div>
        <h2>
          <a href="{% url 'idea_detail' id=idea.id %}">ğŸ¬{{ idea.title }}</a>
        </h2>
        <p>{{ idea.title }}</p>
        <p>ì˜ˆìƒ ê°œë°œ íˆ´: {{ idea.devtool }}</p>
        <p>
          ì•„ì´ë””ì–´ ê´€ì‹¬ë„:
          <button
            class="interest-button"
            data-idea-id="{{ idea.id }}"
            data-action="decrease"
          >
            -
          </button>
          <span class="interest-value" id="interest-{{ idea.id }}">{{ idea.interest }}</span>
          <button
            class="interest-button"
            data-idea-id="{{ idea.id }}"
            data-action="increase"
          >
            +
          </button>
        </p>
      </div>
      {% endfor %}
    </div>

    <script>
      document.querySelectorAll(".star-button").forEach((button) => {
      button.addEventListener("click", () => {
        const ideaId = button.getAttribute("data-idea-id"); // ì•„ì´ë””ì–´ ID ê°€ì ¸ì˜¤ê¸°
        const isStarred = button.textContent === "â˜†"; // í˜„ì¬ ìƒíƒœ í™•ì¸

        // ë³„ ìƒíƒœ í† ê¸€
        button.textContent = isStarred ? "â˜…" : "â˜†";
        button.style.color = isStarred ? "gold" : "gray";

        // AJAX ìš”ì²­ìœ¼ë¡œ ì„œë²„ì— ìƒíƒœ ì €ì¥
        fetch(`/update_star/${ideaId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({
            is_starred: isStarred, // ë³„ ìƒíƒœë¥¼ ì„œë²„ë¡œ ì „ë‹¬
          }),
        }).catch((error) => {
          console.error("Error updating star status:", error);
        });
      });
    });

    document.querySelectorAll(".interest-button").forEach((button) => {
      button.addEventListener("click", () => {
        const ideaId = button.getAttribute("data-idea-id");
        const action = button.getAttribute("data-action");
        const interestValueSpan = document.getElementById("interest-" + ideaId);
        let currentInterest = parseInt(interestValueSpan.textContent);

        // ê´€ì‹¬ë„ ë³€ê²½
        if (action === "increase") {
          currentInterest++;
        } else if (action === "decrease" && currentInterest > 0) {
          currentInterest--;
        }

        // ê´€ì‹¬ë„ ì—…ë°ì´íŠ¸
        interestValueSpan.textContent = currentInterest;

        // AJAX ìš”ì²­ ë³´ë‚´ê¸°
        fetch(`/update_interest/${ideaId}/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({
            interest: currentInterest,
          }),
        }).catch((error) => {
          console.error("Error updating interest:", error);
        });
      });
    });

    // ì •ë ¬ ì˜µì…˜ ë³€ê²½ ì‹œ ë³„ ìƒíƒœ ìœ ì§€
    document.getElementById("sort_by").addEventListener("change", function () {
      const selectedOption = this.value; // ì„ íƒëœ ì •ë ¬ ì˜µì…˜
      const form = this.form;

      // í¼ ì œì¶œ ì „ ë³„ ìƒíƒœ ìœ ì§€ ìš”ì²­
      fetch("/get_star_states/", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
      })
        .then((response) => response.json())
        .then((data) => {
          // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë³„ ìƒíƒœë¥¼ DOMì— ë°˜ì˜
          document.querySelectorAll(".star-button").forEach((button) => {
            const ideaId = button.getAttribute("data-idea-id");
            if (data[ideaId]) {
              button.textContent = "â˜…";
              button.style.color = "gold";
            } else {
              button.textContent = "â˜†";
              button.style.color = "gray";
            }
          });

          // í¼ ì œì¶œí•˜ì—¬ ì •ë ¬ ì˜µì…˜ ì ìš©
          form.submit();
        })
        .catch((error) => {
          console.error("Error fetching star states:", error);
        });
    });
    </script>
  </body>
</html>
